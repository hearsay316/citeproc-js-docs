tinymce.PluginManager.add("citeaddedit",function(a){function b(a){for(var b=[],c=null,d=0,e=g.config.citationByIndex.length;e>d;d++)if(g.config.citationByIndex[d].citationID===a){c=g.config.citationByIndex[d];break}return c&&(b=c.citationItems.map(function(a){return a.id})),b}function c(){for(var a=[],b=[{title:"Geller 2002",id:"item01"},{title:"West 1934",id:"item02"},{title:"Allen 1878",id:"item03"},{title:"American case",id:"item04"},{title:"British case",id:"item05"}],c=0,d=b.length;d>c;c++)a.push({type:"checkbox",name:b[c].id,label:" ",text:b[c].title,value:b[c].id});return a}function d(a,b){for(var c=0,d=b.length;d>c;c++)for(var e=b[c],f=0,g=a.length;g>f;f++)e===a[f].name&&(a[f].checked=!0);return a}function e(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c].parentNode.classList.contains("mce-offscreen-selection")||b.push(a[c]);return b}function f(){var f=a.getDoc(),h=a.selection.getNode(),i="",j="SPAN"==h.tagName&&a.dom.hasClass(h,"citation");j&&(i=h.id||""),g.config.citationByIndex=g.spoofCitations();var k=c(),l=b(i),k=d(k,l);a.windowManager.open({title:"Add/Edit citation",body:k,onsubmit:function(b){var c=[];for(var d in b.data)b.data[d]&&c.push({id:d});var k;if(j){if(i){for(var l=-1,m=e(f.getElementsByClassName("citation")),n=0;n<m.length;n++)if(m[n]===h){l=n;break}if(-1===l)throw"Menu node not found";if(k=g.config.citationByIndex[l],c.length)k.citationItems=c;else{var m=e(f.getElementsByClassName("citation"));if(g.config.citationByIndex=g.config.citationByIndex.slice(0,l).concat(g.config.citationByIndex.slice(l+1)),0===g.config.citationByIndex.length)return void callInitProcessor();k=g.config.citationByIndex[0];var o=f.getElementById(i);o.parentNode.removeChild(o)}}}else{if(!c.length)return;a.selection.collapse(!0),a.execCommand("mceInsertContent",!1,'<span id="new-citation" class="citation mceNonEditable">{Citation}</span>'),h=f.getElementById("new-citation"),h.removeAttribute("id"),k={citationItems:c,properties:{noteIndex:0}}}for(var p=e(f.getElementsByClassName("citation")),q=[],r=[],s=0,n=0,t=p.length;t>n;n++){var o=p[n];if(o===h){var s=0;j&&(s=1),g.config.citationByIndex.slice(0,n).length&&(q=g.config.citationByIndex.slice(0,n).map(function(a){return[a.citationID,0]})),g.config.citationByIndex.slice(n+s).length&&(r=g.config.citationByIndex.slice(n+s).map(function(a){return[a.citationID,0]}));break}}if("note"===g.config.mode){for(var n=0,t=q.length;t>n;n++)q[n][1]=n+1;var s=q.length+1;k.properties.noteIndex=s;for(var n=0,t=r.length;t>n;n++)r[n][1]=n+s+1}g.callRegisterCitation(k,q,r)}})}var g=a.plugins.citesupport.citesupport;a.addCommand("mceCite",f),a.addButton("citeaddedit",{icon:!1,text:"Add/Edit citation",onclick:f}),a.addMenuItem("citeaddedit",{icon:!1,text:"AddEdit citation",context:"insert",onclick:f})});